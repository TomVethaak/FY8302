% ------ Standard packages ------ %
\usepackage[usenames,dvipsnames,svgnames]{xcolor}
\RequirePackage{amsmath,amssymb,braket,caption,dsfont,enumerate,extarrows,float,graphicx,mathrsfs,mdframed,microtype,multicol,notoccite,pdfpages,placeins,siunitx,slashed,subcaption,tensor}
\newcommand\bmmax{2}
\RequirePackage{bm}
\RequirePackage[hidelinks]{hyperref}
\RequirePackage[utf8]{inputenc}
\RequirePackage[showonlyrefs]{mathtools}
\RequirePackage[version=3]{mhchem}
\RequirePackage{tikz}
\usetikzlibrary{arrows,decorations.markings,shapes,snakes,tikzmark}
\tikzset{cross/.style={cross out, draw=black, minimum size=2*(#1-\pgflinewidth), inner sep=0pt, outer sep=0pt},
%default radius will be 1pt. 
cross/.default={5pt}}
\captionsetup{width=0.8\textwidth}

% ------ Fetch the font size ------ %
\newlength{\mytextsize}
\makeatletter
	  \setlength{\mytextsize}{\f@size pt}
\makeatother

% ------ Bigger parentheses ----- %
\makeatletter
\newcommand{\vast}{\bBigg@{4}}
\newcommand{\Vast}{\bBigg@{5}}
\makeatother

% ------ Math operators ------ %
\DeclareMathOperator{\arctanh}{arctanh}
\DeclareMathOperator{\cosech}{cosech}
\DeclareMathOperator{\Fourier}{\ensuremath{\mathscr{F}}}
\DeclareMathOperator{\sign}{\ensuremath{\text{sign}}}
\DeclareMathOperator{\Tr}{Tr\!}

% ------ Environments ------ %
\definecolor{lightgray}{gray}{0.92}
\newenvironment{Indent}{\begin{adjustwidth}{2\parindent}{2\parindent}\begin{mdframed}[backgroundcolor=lightgray,linecolor=lightgray]\begin{small}}{\end{small}\end{mdframed}\end{adjustwidth}}
\newenvironment{Indentskip}{\FloatBarrier\vspace*{1\baselineskip}\begin{adjustwidth}{2\parindent}{2\parindent}\begin{mdframed}[backgroundcolor=lightgray,linecolor=lightgray]\begin{small}}{\end{small}\end{mdframed}\end{adjustwidth}\vspace*{1\baselineskip}}
\newcommand*{\Quote}[1]{\begin{quotation}\noindent\textit{\raisebox{-0.2ex}{{\large``}}#1{\large''}}\end{quotation}}
\newcommand*{\Qquote}[2][]{\makebox[\textwidth][c]{ %
	\begin{minipage}[pos=c]{0.8\textwidth} %
		\emph{\raisebox{-0.2ex}{{\large``}}#2{\large''}} %
		\begin{flushright}
			-#1 %
		\end{flushright} %
	\end{minipage} %
	}}
\newcommand*{\CenterFig}[1]{\begin{center}\makebox[\textwidth]{\includegraphics{#1}}\end{center}}

% ------ Math commands and symbols ------ %
\newcommand*{\anni}{\ensuremath{\psi^{\vphantom{\dagger}}}}
\newcommand*{\annib}{\ensuremath{A^{\vphantom{\dagger}}}}
\newcommand*{\Anni}{\ensuremath{c^{\vphantom{\dagger}}}}
\newcommand*{\Annib}{\ensuremath{a^{\vphantom{\dagger}}}}
\newcommand*{\Annibb}{\ensuremath{b^{\vphantom{\dagger}}}}
\newcommand*{\Area}{\ensuremath{\mathscr{A}}}
\newcommand*{\avg}[1]{\ensuremath{\langle\;#1\;\rangle}} % Nicolai insert
\newcommand*{\B}[1]{\relax\ifmmode\bm{#1}\else\textbf{#1}\fi}
\newcommand*{\bandgap}{\ensuremath{\Delta}}
\newcommand*{\Bandgap}{\ensuremath{\hat{\Delta}}}
\newcommand*{\Bath}{\ensuremath{\mathcal{B}}}
\newcommand*{\Bfield}{\ensuremath{B}}
\newcommand*{\Bm}[1]{\begin{bmatrix}#1\end{bmatrix}}
\newcommand*{\Boltzmann}{\ensuremath{k}}
\newcommand*{\bulprod}{\ensuremath{\bullet}}
\newcommand*{\bulcomma}{\ensuremath{\,\overset{\bullet}{,}\,}}
\newcommand*{\cc}{\ensuremath{c}}
\newcommand*{\charge}{\ensuremath{q}}
\newcommand*{\chempot}{\ensuremath{\mu}}
\newcommand*{\circcomma}{\,\overset{\circ}{,}\,}
\newcommand*{\circprod}{\circ}
\newcommand*{\CoherenceLength}{\ensuremath{\xi}}
\newcommand*{\commu}[1]{\ensuremath{\left[#1\right]}}
\newcommand*{\commum}[1]{\ensuremath{\left[#1\right]_-}}
\newcommand*{\commump}[1]{\ensuremath{\left[#1\right]_\mp}}
\newcommand*{\commup}[1]{\ensuremath{\left[#1\right]_+}}
\newcommand*{\commupm}[1]{\ensuremath{\left[#1\right]_\pm}}
\newcommand*{\con}[1]{{\!\!#1}}
\newcommand*{\convol}{\ensuremath{\ast}}
\newcommand*{\crea}{\ensuremath{\psi^\dagger}}
\newcommand*{\creab}{\ensuremath{A^\dagger}}
\newcommand*{\Crea}{\ensuremath{c^\dagger}}
\newcommand*{\Creab}{\ensuremath{a^\dagger}}
\newcommand*{\Creabb}{\ensuremath{b^\dagger}}
\newcommand*{\Current}{\ensuremath{I}}
\newcommand*{\dd}{d}
\newcommand*{\df}[1]{\hat{\B{#1}}}
\newcommand*{\dt}[1]{\B{#1}}
\newcommand*{\de}[1]{\ensuremath{\check{\B{#1}}}}
\newcommand*{\DiffusionConstant}{\ensuremath{D}}
\newcommand*{\Dim}[1]{\ensuremath{\left[#1\right]}}
\newcommand*{\distf}{\ensuremath{\df{\mathpzc{h\,}}\!}}
\newcommand*{\disto}{\ensuremath{\mathpzc{h}}}
\newcommand*{\DistributionEnergy}{\ensuremath{\df{E}_{\smash{\mathpzc{h\,}}}}}
\newcommand*{\DebyeTemperature}{\ensuremath{\Theta}}
\newcommand*{\DOS}{D}
\newcommand*{\down}{\downarrow}
\newcommand*{\ee}{\ensuremath{e}}
\newcommand*{\EFermi}{\ensuremath{\varepsilon_F}}
\newcommand*{\Efficiency}{\ensuremath{\eta{}}}
\newcommand*{\Efield}{\ensuremath{E}}
\newcommand*{\ElSpecHeat}{\ensuremath{\gamma}}
\newcommand*{\Emagnetic}{\ensuremath{u_M}}
\newcommand*{\Energy}{\ensuremath{E}}
\newcommand*{\EnergyDensity}{\ensuremath{e}}
\newcommand*{\Enthalpy}{\ensuremath{E}}
\newcommand*{\Entropy}{\ensuremath{S}}
\newcommand*{\EntropyDensity}{\ensuremath{s}}
\newcommand*{\Fenvf}{\ensuremath{\hat{\B{f}}}}
\newcommand*{\Fenvt}{\ensuremath{\B{f}}}
\newcommand*{\Flux}{\ensuremath{\Phi}}
\newcommand*{\Fe}{\de{F}}
\newcommand*{\Ff}{\df{F}}
\newcommand*{\Fo}{\ensuremath{F}}
\newcommand*{\Ft}{\dt{F}}
\newcommand*{\Genergy}{\ensuremath{\epsilon}}
\newcommand*{\genmom}{\B{p}}
\newcommand*{\Ge}{\de{G}}
\newcommand*{\Gf}{\df{G}}
\newcommand*{\Go}{\ensuremath{G}}
\newcommand*{\Gt}{\dt{G}}
\newcommand*{\Gibbs}{\ensuremath{G}}
\newcommand*{\GibbsDensity}{\ensuremath{g}}
\newcommand{\gv}[1]{\ensuremath{\mbox{\boldmath$ #1 $}}} % Nicolai insert 
\newcommand*{\Ha}{\ensuremath{\mathcal{H}}}
\newcommand*{\Hac}{\ensuremath{H}}
\newcommand*{\Haf}{\ensuremath{\hat{\B{H}}}}
\newcommand*{\Hae}{\ensuremath{\check{\B{H}}}}
\newcommand*{\Heat}{\ensuremath{Q}}
\newcommand*{\HeatCapacity}{\ensuremath{C}}
\newcommand*{\Heaviside}{\ensuremath{\Theta}}
\newcommand*{\Helmholtz}{\ensuremath{F}}
\newcommand*{\HelmholtzDensity}{\ensuremath{f}}
\newcommand*{\Hfield}{\ensuremath{H}}
\newcommand*{\id}{\mathds{1}}
\newcommand*{\Int}{\displaystyle\int}
\newcommand*{\Internal}{\ensuremath{U}}
\newcommand*{\InternalDensity}{\ensuremath{u}}
\newcommand*{\IPM}{\ensuremath{E}}
\newcommand*{\IPMDensity}{\ensuremath{e}}
\newcommand*{\Jacobian}{\mathscr{J}}
\newcommand*{\kinE}{\ensuremath{T}}
\newcommand*{\lagrangian}{\mathcal{L}}
\newcommand*{\LatentHeat}{\ensuremath{L}}
\newcommand*{\Length}{\ell}
\newcommand*{\Lifetime}{\ensuremath{\tau}}
\newcommand*{\LocalFlux}{\ensuremath{h}}
\newcommand*{\M}{\mathscr{M}}
\newcommand*{\Magnetisation}{\ensuremath{M}}
\newcommand*{\MagSus}{\ensuremath{\chi}}
\newcommand*{\mass}{\ensuremath{m}}
\newcommand*{\Max}{\displaystyle\max}
\newcommand*{\MeanFreePath}{\ensuremath{\Length_e}}
\newcommand*{\nablac}{\tilde{\nabla}}
\newcommand*{\Number}{n^{\vphantom{\dagger}}}
\newcommand*{\oInt}{\displaystyle\oint}
\newcommand*{\operator}{\ensuremath{\hat{\mathcal{O}}}}
\newcommand*{\OrderParameter}{\ensuremath{\omega}}
\newcommand*{\Partition}{\ensuremath{\mathcal{Z}}}
\newcommand*{\paulie}{\check{\rho}}
\newcommand*{\paulif}{\hat{\rho}}
\newcommand*{\paulit}{\bm{\tau}}
\newcommand*{\PenDepth}{\ensuremath{\lambda}}
\newcommand*{\Permeability}{\ensuremath{\mu_0}}
\newcommand*{\PhaseCoherenceLength}{\ensuremath{\Length_\phi}}
\newcommand*{\Pm}[1]{\begin{pmatrix}#1\end{pmatrix}}
\newcommand*{\Pressure}{\ensuremath{P}}
\newcommand*{\Prod}{\displaystyle\prod}
\newcommand*{\qFe}{\de{f}}
\newcommand*{\qFf}{\df{f}}
\newcommand*{\qFo}{\ensuremath{f}}
\newcommand*{\qFt}{\dt{f}}
\newcommand*{\qGe}{\de{g}}
\newcommand*{\qGf}{\df{g}}
\newcommand*{\qGo}{\ensuremath{g}}
\newcommand*{\qGt}{\dt{g}}
\newcommand*{\Radius}{\ensuremath{a}}
\newcommand*{\RedRad}{\ensuremath{\alpha}}
\newcommand*{\RedTemp}{\ensuremath{t}}
\newcommand*{\Resistance}{\ensuremath{R}}
\newcommand*{\scalarp}{\ensuremath{\varphi}}
\newcommand*{\SelfEnergy}{\ensuremath{\Sigma}}
\newcommand*{\qSelfEnergy}{\ensuremath{\sigma}}
\newcommand*{\Sommerfeld}{\ensuremath{\gamma}}
\newcommand*{\SpectralI}{\ensuremath{\mathcal{S}}}
\newcommand*{\spaulif}{\hat{\tau}}
\newcommand*{\spin}{\ensuremath{\B{\sigma}}}
\newcommand*{\Spin}{\ensuremath{\bm{S}}}
\newcommand*{\spinfield}{\ensuremath{\B{s}}}
\newcommand*{\spinflip}{\ensuremath{\hat{\mathcal{S}}}}
\newcommand*{\starprod}{\ensuremath{\small\odot}}
\newcommand*{\starcomma}{\ensuremath{\,\overset{\odot}{,}\,}}
\newcommand*{\Sum}{\displaystyle\sum}
\newcommand*{\System}{\ensuremath{\mathcal{S}}}
\newcommand*{\tc}[1]{\tilde{#1}}
\newcommand*{\Temperature}{\ensuremath{T}}
\newcommand*{\Time}{\ensuremath{t}}
\newcommand*{\Underline}[1]{\underline{\smash{#1}}}
\newcommand*{\unitv}{\hat{e}}
\newcommand*{\up}{\uparrow}
\let\vaccent=\v % rename builtin command \v{} to \vaccent{} % Nicolai insert
\renewcommand{\v}[1]{\B{#1}} % for vectors & Nicolai insert
\newcommand*{\vareps}{\varepsilon}
\newcommand*{\vFermi}{\ensuremath{v_F}}
\newcommand*{\Vector}[1]{\vec{#1}}
\newcommand*{\vectorp}{\ensuremath{\bm{A}}}
\newcommand{\vm}[1]{\begin{vmatrix}#1\end{vmatrix}}
\newcommand{\Vm}[1]{\begin{Vmatrix}#1\end{Vmatrix}}
\newcommand*{\Volume}{\ensuremath{V}}
\newcommand*{\Work}{\ensuremath{W}}

% ------ Feynman diagrams ------ %
\RequirePackage{feynmp-auto}
\newenvironment{feynman}[1]{\begin{center}\begin{fmffile}{#1}\vspace*{\baselineskip}}{\vspace*{\baselineskip}\end{fmffile}\end{center}}
\newcommand{\marrow}[5]{\fmfcmd{style_def marrow#1 expr p = drawarrow subpath (1/4, 3/4) of p shifted 6 #2 withpen pencircle scaled 0.4; label.#3(btex #4 etex, point 0.5 of p shifted 6 #2); enddef;} \fmf{marrow#1,tension=0}{#5}}
\newcommand{\Marrow}[7]{\fmfcmd{style_def marrow#1 expr p = drawarrow subpath (1/4, 3/4) of p shifted #6 #2 withpen pencircle scaled 0.4; label.#3(btex #4 etex, point 0.5 of p shifted #7 #2); enddef;} \fmf{marrow#1,tension=0}{#5}}

% ------ Include figure ------ %
\newcommand{\includefigure}[4][1]{ 
   \begin{figure}[H] 
   \centering 
   \includegraphics[width=#1\textwidth]{#2} 
   \caption{#4} 
   \label{fig:#3} 
   \end{figure} 
 }

% ------ Multiple equation reference ------ %
\RequirePackage{xparse}
\ExplSyntaxOn
\NewDocumentCommand{\mref}{m}{\quinn_mref:n {#1}}
\seq_new:N \l_quinn_mref_seq
\cs_new:Npn \quinn_mref:n #1{
	\seq_set_split:Nnn \l_quinn_mref_seq { , } { #1 }
	\seq_pop_right:NN \l_quinn_mref_seq \l_tmpa_tl
		( % print the left parenthesis
	\seq_map_inline:Nn \l_quinn_mref_seq
		{ \ref{##1},\nobreakspace } % print the first references
	\exp_args:NV \ref \l_tmpa_tl % print the last or only one
		) % print the right parenthesis
}
\ExplSyntaxOff

% ------ Subequation reference ------ %
\providecommand{\phantomsection}{}% In case hyperref is not loaded
\AtBeginDocument{\let\textlabel\label}% http://tex.stackexchange.com/q/9939/5764
\makeatletter
\newcommand{\mylabel}[2]{\raisebox{\normalbaselineskip}{\phantomsection}#1%
  \def\@currentlabel{#1}\textlabel{#2}}
\makeatother

% ------ Slightly tweaked version of siunitx ------ %
\RequirePackage{expl3,kvoptions,siunitx}
\SetupKeyvalOptions{family=threshold,prefix=threshold@}
\DeclareStringOption[1]{low}[0.01]
\DeclareStringOption[1]{high}[100]
\ProcessKeyvalOptions*
\sisetup{scientific-notation=true}
\ExplSyntaxOn
	\cs_new_eq:NN \fpcmpTF \fp_compare:nTF
\ExplSyntaxOff
\let\OldNum\num%
\renewcommand*{\num}[2][]{%
    \fpcmpTF{abs(#2)<=\threshold@low}{%
        \OldNum[scientific-notation=true,#1]{#2}%
    }{%
        \fpcmpTF{abs(#2)>=\threshold@high}{%
            \OldNum[scientific-notation=true,#1]{#2}%
        }{%
            \OldNum[scientific-notation=false,#1]{#2}%
        }%
    }%
}

% ------ Blank page command ------ %
\newcommand{\blankpage}{
	\clearpage
	\thispagestyle{empty}
	\mbox{}
	\clearpage
}

% ------ Numbered page command ------ %
\newcommand{\numberedpage}{
	\clearpage
	\mbox{}
	\clearpage
}

% ------ JoinUp and JoinDown ------ %
\newcommand{\JoinUp}[5]{\begin{tikzpicture}[remember picture,overlay,line width=0.05\mytextsize]
	\draw([shift={(#1\mytextsize,#2\mytextsize)}]pic cs:start#5) -- ++(0pt,0.7\mytextsize) -| ([shift={(#3\mytextsize,#4\mytextsize)}]pic cs:end#5);
	\end{tikzpicture}}
\newcommand{\JoinDown}[5]{\begin{tikzpicture}[remember picture,overlay,line width=0.05\mytextsize]
	\draw([shift={(#1\mytextsize,#2\mytextsize)}]pic cs:start#5) -- ++(0pt,-0.7\mytextsize) -| ([shift={(#3\mytextsize,#4\mytextsize)}]pic cs:end#5);
	\end{tikzpicture}}
	
% ------ ArrowUp and ArrowDown ------ %
\newcommand{\ArrowUp}[5]{\begin{tikzpicture}[remember picture,overlay,line width=0.05\mytextsize]
	\draw([shift={(#1\mytextsize,#2\mytextsize)},->]pic cs:start#5) -- ([shift={(#3\mytextsize,#4\mytextsize)}]pic cs:end#5);
	\end{tikzpicture}}
\newcommand{\ArrowDown}[5]{\begin{tikzpicture}[remember picture,overlay,line width=0.05\mytextsize]
	\draw([shift={(#1\mytextsize,#2\mytextsize)},->]pic cs:start#5) -- ([shift={(#3\mytextsize,#4\mytextsize)}]pic cs:end#5);
	\end{tikzpicture}}

% ------ Citenum for BibLaTeX ------ %
%\DeclareCiteCommand{\citenum}
%  {}
%  {\printfield{labelnumber}}
%  {}
%  {}

% ------ Vector arrow ------ %

